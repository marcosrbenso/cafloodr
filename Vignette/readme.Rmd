---
title: "Preparing Input Data and Running CADDIES/CAFLOOD Using `cafloodr`"
author: "Marcos Roberto Benso"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Preparing Input Data and Running CADDIES/CAFLOOD}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Importa libraries

```{r}
library(imputeTS)
library(zoo)
library(gstat)
library(sf)
library(sp)

```

## Interpolate precipitation data



```{r}



dataset <- read.csv("Data/rainfall_2021.csv")
dataset

stations <- (read.csv("Data/CoordenadasEstacoes (coordinate).csv"))
coordinates(stations) <- ~X+Y

aricanduva <- st_read("Data/aricanduva.shp")

# IDW

events <-
  data.frame(
    id = c("Event_1_SP"),
    start = as.POSIXct(c("2021-01-25 20:00"),tz = "UTC"),
    end =  as.POSIXct(c("2021-02-19 18:00"),tz = "UTC")
  )

rain_events <- c()

for(t in 1:nrow(events)){
  dates <- seq(from = (events$start[t]),
               to = (events$end[t]),by = "10 min")


  results <- rep(NA,length(dates))
  for(i in 1:length(dates)){
    tryCatch({
      sub_sel <- dataset |>
        subset(DATA == dates[i]) |>
        merge(stations,
              by.x = "Posto",
              by.y = "ID") |>
        dplyr::select(X,Y,Rain3) |>
        na.omit() |>
        st_as_sf(coords = c("X",'Y'),crs="WGS84") |>
        st_transform(crs = st_crs(aricanduva))


      rainSP <- as(sub_sel, 'Spatial')
      neighbors <- length(rainSP) - 1
      beta <- 2

      idw_rain <- gstat::gstat(
        formula = Rain3 ~ 1, # intercept-only model
        data = rainSP,
        nmax = neighbors,
        set = list(idp = beta)
      )

      predict(
        idw_rain, aricanduva
      )$var1.pred -> results[i]

    },error = function(e){
      NA
    })

  }

  rain_events[[t]] <- unlist(results)


  write.csv(
    data.frame(start = events$start[t],
               end = events$end[t],
               events = events$id[t],
               prec = unlist(results)),
    paste0(events$id[t],"prec.csv")
  )
}


```

## Setting up the working paths

Define the input and output folders, and the path to your CAFLOOD executable:

```{r}

library(cafloodr)

caflood_path <- "C:/Path/CAFLOOD"
Input  <- "Data/"
Output <- "E:\\01_DTI-A\\03_Analyses\\01_SP\\dem_resolution_outputs_certo_3\\"


```

## Running CAFLOOD

The figure sizes have been customised so that you can easily put two images side-by-side. 

### Set the parameters

```{r, fig.show='hold'}

param <- list(alpha_fraction = 0.1,
              roughness_global = 0.009, #0.06
              slope_tolerance = 0.528,
              boundary_ele = -9,
              Raster_WD_Tolerance = 0.1,
              Upstream_Reduction = 0.5)


```

### Run CAFLOOD

You can now call the cafloodr_A01() function to process inputs, create the control file, and execute the model:

```{r}

cafloodr_A01(param,
             caflood_path,
             Input,
             Output,
             event_name = "Event_test",
             dem_name = "ari_lidar_30m",
             path2 = "",
             outlet_path = "estacoes.shp",
             rain_path = "Event_1_SP_prec.csv",
             stream_network = "aricanduva_streams2",
             snap_dist = 30)

```
